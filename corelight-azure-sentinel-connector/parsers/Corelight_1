// Usage Instruction : 
// Paste below query in log analytics, click on Save button and select as Function from drop down by specifying function name and alias as Corlight.
// Function usually takes 10-15 minutes to activate. You can then use function alias from any other queries (e.g. Corelight | take 10).
// Reference : Using functions in Azure monitor log queries : https://docs.microsoft.com/azure/azure-monitor/log-query/functions
let Corelight_view = view () {
    Corelight_CL | where isnotempty(Message)
| extend tmp = parse_json(Message)
| evaluate bag_unpack(tmp)| extend path_parts = parse_path(log_file_s)
    | extend EventType = extract("(^.*?)_\\d+", 1, tostring(path_parts["Filename"])),
        EventVendor="Corelight",
        EventProduct="Corelight Sensor",
        SrcDvcHostname=column_ifexists('hostname_s', ''),
        EventEndTime=column_ifexists('ts', ''),
        SrcDvcFile=column_ifexists('log_file_s', '')
    | project-away path_parts, log_file_s
};
let Corelight_http_view = view () {
    Corelight_view | where EventType == "http" or EventType == "http_red"
    | extend
        NetworkProtocol="tcp",
        HttpRequestHeaderNames=column_ifexists('client_header_names', ''),
        HttpCookieVariables=column_ifexists('cookie_vars', ''),
        SoftwareFlashVersionOriginal=column_ifexists('flash_version', ''),
        HttpRequestHeaderHost=column_ifexists('host', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        HttpInformationalCode=column_ifexists('info_code', ''),
        HttpInformationalMessage=column_ifexists('info_msg', ''),
        HttpRequestMethod=column_ifexists('method', ''),
        ZeekHttpOmniture=column_ifexists('omniture', ''),
        SrcFileName=column_ifexists('orig_filenames', ''),
        ZeekIdOrigFuids=column_ifexists('orig_fuids', ''),
        SrcMimeType=column_ifexists('orig_mime_types', ''),
        HttpRequestHeaderOrigin=column_ifexists('origin', ''),
        UserPassword=column_ifexists('password', ''),
        HttpResponseBodyOriginal=column_ifexists('post_body', ''),
        HttpProxiedHeaders=column_ifexists('proxied', ''),
        HttpReferrerOriginal=column_ifexists('referrer', ''),
        HttpRequestBodyBytes=column_ifexists('request_body_len', ''),
        FileName=column_ifexists('resp_filenames', ''),
        ZeekIdRespFuids=column_ifexists('resp_fuids', ''),
        FileMimeType=column_ifexists('resp_mime_types', ''),
        HttpResponseBodyBytes=column_ifexists('response_body_len', ''),
        HttpResponseHeaderNames=column_ifexists('server_header_names', ''),
        HttpStatusCode=column_ifexists('status_code', ''),
        HttpStatusMessage=column_ifexists('status_msg', ''),
        ZeekHttpTags=column_ifexists('tags', ''),
        ZeekHttpTransDepth=column_ifexists('trans_depth', ''),
        EventUid=column_ifexists('uid', ''),
        UrlOriginal=column_ifexists('uri', ''),
        UrlQueryValues=column_ifexists('uri_vars', ''),
        UserAgentOriginal=column_ifexists('user_agent', ''),
        UserName=column_ifexists('username', ''),
        HttpVersion=column_ifexists('version', ''),
        DstHostName=column_ifexists('http_header_host', ''),
        FilePath=column_ifexists('file_name', ''),
        SrcFilePath=column_ifexists('src_file_name', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        NetworkProtocol,
        HttpRequestHeaderNames,
        HttpCookieVariables,
        SoftwareFlashVersionOriginal,
        HttpRequestHeaderHost,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        HttpInformationalCode,
        HttpInformationalMessage,
        HttpRequestMethod,
        ZeekHttpOmniture,
        SrcFileName,
        ZeekIdOrigFuids,
        SrcMimeType,
        HttpRequestHeaderOrigin,
        UserPassword,
        HttpResponseBodyOriginal,
        HttpProxiedHeaders,
        HttpReferrerOriginal,
        HttpRequestBodyBytes,
        FileName,
        ZeekIdRespFuids,
        FileMimeType,
        HttpResponseBodyBytes,
        HttpResponseHeaderNames,
        HttpStatusCode,
        HttpStatusMessage,
        ZeekHttpTags,
        ZeekHttpTransDepth,
        EventUid,
        UrlOriginal,
        UrlQueryValues,
        UserAgentOriginal,
        UserName,
        HttpVersion,
        DstHostName,
        FilePath,
        SrcFilePath
};
let Corelight_conn_view = view () {
    Corelight_view | where EventType == "conn" or EventType == "conn_red"
    | extend
        FingerprintNetworkCommunityId=column_ifexists('community_id', ''),
        NetworkConnectionState=column_ifexists('conn_state', ''),
        EventDuration=column_ifexists('duration', ''),
        NetworkConnectionHistory=column_ifexists('history', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        ZeekMetaSrcIpAddrSource=column_ifexists('id.orig_h_name.src', ''),
        ZeekMetaSrcIpAddrHostName=column_ifexists('id.orig_h_name.vals', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        ZeekMetaDstIpAddrSource=column_ifexists('id.resp_h_name.src', ''),
        ZeekMetaDstIpAddrHostName=column_ifexists('id.resp_h_name.vals', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        NetworkInnerVlanId=column_ifexists('inner_vlan', ''),
        ZeekConnLocalSrc=column_ifexists('local_orig', ''),
        ZeekConnLocalDst=column_ifexists('local_resp', ''),
        NetworkMissedBytes=column_ifexists('missed_bytes', ''),
        SrcBytes=column_ifexists('orig_bytes', ''),
        ZeekOrigCc=column_ifexists('orig_cc', ''),
        SrcIpBytes=column_ifexists('orig_ip_bytes', ''),
        SrcMac=column_ifexists('orig_l2_addr', ''),
        SrcPackets=column_ifexists('orig_pkts', ''),
        NetworkProtocol=column_ifexists('proto', ''),
        DstBytes=column_ifexists('resp_bytes', ''),
        ZeekRespCc=column_ifexists('resp_cc', ''),
        DstIpBytes=column_ifexists('resp_ip_bytes', ''),
        DstMac=column_ifexists('resp_l2_addr', ''),
        DstPackets=column_ifexists('resp_pkts', ''),
        NetworkApplication=column_ifexists('service', ''),
        ZeekIdTunnelParents=column_ifexists('tunnel_parents', ''),
        EventUid=column_ifexists('uid', ''),
        NetworkOuterVlanId=column_ifexists('vlan', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        FingerprintNetworkCommunityId,
        NetworkConnectionState,
        EventDuration,
        NetworkConnectionHistory,
        SrcIpAddr,
        ZeekMetaSrcIpAddrSource,
        ZeekMetaSrcIpAddrHostName,
        SrcPort,
        DstIpAddr,
        ZeekMetaDstIpAddrSource,
        ZeekMetaDstIpAddrHostName,
        DstPort,
        NetworkInnerVlanId,
        ZeekConnLocalSrc,
        ZeekConnLocalDst,
        NetworkMissedBytes,
        SrcBytes,
        ZeekOrigCc,
        SrcIpBytes,
        SrcMac,
        SrcPackets,
        NetworkProtocol,
        DstBytes,
        ZeekRespCc,
        DstIpBytes,
        DstMac,
        DstPackets,
        NetworkApplication,
        ZeekIdTunnelParents,
        EventUid,
        NetworkOuterVlanId
};
let Corelight_dns_view = view () {
    Corelight_view | where EventType == "dns" or EventType == "dns_red"
    | extend
        DnsFlagsAuthoritative=column_ifexists('AA', ''),
        DnsFlagsRecursionAvailable=column_ifexists('RA', ''),
        DnsFlagsRecursionDesired=column_ifexists('RD', ''),
        DnsFlagsTruncated=column_ifexists('TC', ''),
        DnsResponseTtl=column_ifexists('TTLs', ''),
        DnsFlagsZ=column_ifexists('Z', ''),
        DnsAdditionalName=column_ifexists('addl', ''),
        DnsResponseName=column_ifexists('answers', ''),
        DnsAdditionalAuthoritativeName=column_ifexists('auth', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        NetworkProtocol=column_ifexists('proto', ''),
        DnsQueryClass=column_ifexists('qclass', ''),
        DnsQueryClassName=column_ifexists('qclass_name', ''),
        DnsQueryType=column_ifexists('qtype', ''),
        DnsQueryTypeName=column_ifexists('qtype_name', ''),
        DnsQueryName=column_ifexists('query', ''),
        DnsResponseCode=column_ifexists('rcode', ''),
        DnsResponseCodeName=column_ifexists('rcode_name', ''),
        DnsRejected=column_ifexists('rejected', ''),
        DnsRtt=column_ifexists('rtt', ''),
        DnsTransactionId=column_ifexists('trans_id', ''),
        EventUid=column_ifexists('uid', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        DnsFlagsAuthoritative,
        DnsFlagsRecursionAvailable,
        DnsFlagsRecursionDesired,
        DnsFlagsTruncated,
        DnsResponseTtl,
        DnsFlagsZ,
        DnsAdditionalName,
        DnsResponseName,
        DnsAdditionalAuthoritativeName,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        NetworkProtocol,
        DnsQueryClass,
        DnsQueryClassName,
        DnsQueryType,
        DnsQueryTypeName,
        DnsQueryName,
        DnsResponseCode,
        DnsResponseCodeName,
        DnsRejected,
        DnsRtt,
        DnsTransactionId,
        EventUid
};
let Corelight_files_view = view () {
    Corelight_view | where EventType == "files" or  EventType == "files_red"
    | extend
       ZeekFilesAnalyzers=column_ifexists('analyzers', ''),
        ZeekIdConnUids=column_ifexists('conn_uids', ''),
        Depth=column_ifexists('depth', ''),
        Duration=column_ifexists('duration', ''),
        ZeekFilesEntropy=column_ifexists('entropy', ''),
        ZeekFilesExtracted=column_ifexists('extracted', ''),
        ZeekFilesExtractedCutoff=column_ifexists('extracted_cutoff', ''),
        ZeekFilesExtractedSize=column_ifexists('extracted_size', ''),
        FileName=column_ifexists('filename', ''),
        ZeekIdFuid=column_ifexists('fuid', ''),
        IsOrig=column_ifexists('is_orig', ''),
        LocalOrig=column_ifexists('local_orig', ''),
        HashMd5=column_ifexists('md5', ''),
        FileMimeType=column_ifexists('mime_type', ''),
        ZeekFilesMissingBytes=column_ifexists('missing_bytes', ''),
        ZeekFilesOverflowBytes=column_ifexists('overflow_bytes', ''),
        ZeekIdParentFuid=column_ifexists('parent_fuid', ''),
        SrcIpAddr=column_ifexists('rx_hosts', ''),
        ZeekFilesSeenBytes=column_ifexists('seen_bytes', ''),
        HashSha1=column_ifexists('sha1', ''),
        HashSha256=column_ifexists('sha256', ''),
        Source=column_ifexists('source', ''),
        ZeekFilesTimedout=column_ifexists('timedout', ''),
        FileSize=column_ifexists('total_bytes', ''),
        DstIpAddr=column_ifexists('tx_hosts', ''),
        X509=column_ifexists('x509', ''),
        EventUid=column_ifexists('z_Enrichment', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        ZeekFilesAnalyzers,
        ZeekIdConnUids,
        Depth,
        Duration,
        ZeekFilesEntropy,
        ZeekFilesExtracted,
        ZeekFilesExtractedCutoff,
        ZeekFilesExtractedSize,
        FileName,
        ZeekIdFuid,
        IsOrig,
        LocalOrig,
        HashMd5,
        FileMimeType,
        ZeekFilesMissingBytes,
        ZeekFilesOverflowBytes,
        ZeekIdParentFuid,
        SrcIpAddr,
        ZeekFilesSeenBytes,
        HashSha1,
        HashSha256,
        Source,
        ZeekFilesTimedout,
        FileSize,
        DstIpAddr,
        X509,
        EventUid  
};
let Corelight_dpd_view = view () {
    Corelight_view | where EventType == "dpd"
    | extend
        NetworkProtocol=column_ifexists('proto', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        EventUid=column_ifexists('uid', ''),
        Analyzer=column_ifexists('analyzer', ''),
        FailureReason=column_ifexists('failure_reason', ''),
        PacketSegment=column_ifexists('packet_segment', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        NetworkProtocol,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        EventUid,
        Analyzer,
        FailureReason,
        PacketSegment   
};

let Corelight_dhcp_view = view () {
    Corelight_view | where EventType == "dhcp"
    | extend
        AgentRemoteId=column_ifexists('agent_remote_id', ''),
        DhcpAssignedIpAddr=column_ifexists('assigned_addr', ''),
        DhcpCircuitId=column_ifexists('circuit_id', ''),
        SrcIpAddr=column_ifexists('client_addr', ''),
        SrcFqdn=column_ifexists('client_fqdn', ''),
        ClientMessage=column_ifexists('client_message', ''),
        ClientSoftware=column_ifexists('client_software', ''),
        SrcDomain=column_ifexists('domain', ''),
        EventDuration=column_ifexists('duration', ''),
        SrcHostName=column_ifexists('host_name', ''),
        DhcpLeaseTime=column_ifexists('lease_time', ''),
        SrcMac=column_ifexists('mac', ''),
        MsgOrig=column_ifexists('msg_orig', ''),
        MsgTypes=column_ifexists('msg_types', ''),
        DhcpRequestedIpAddr=column_ifexists('requested_addr', ''),
        DstIpAddr=column_ifexists('server_addr', ''),
        ServerMessage=column_ifexists('server_message', ''),
        ServerSoftware=column_ifexists('server_software', ''),
        DhcpSubscriberId=column_ifexists('subscriber_id', ''),
        ZeekIdUids=column_ifexists('uids', ''),
        EventUid=column_ifexists('zeek_id_uids', ''),
        NetworkProtocol="udp"
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        AgentRemoteId,
        DhcpAssignedIpAddr,
        DhcpCircuitId,
        SrcIpAddr,
        SrcFqdn,
        ClientMessage,
        ClientSoftware,
        SrcDomain,
        EventDuration,
        SrcHostName,
        DhcpLeaseTime,
        SrcMac,
        MsgOrig,
        MsgTypes,
        DhcpRequestedIpAddr,
        DstIpAddr,
        ServerMessage,
        ServerSoftware,
        DhcpSubscriberId,
        ZeekIdUids,
        EventUid,
        NetworkProtocol
};
let Corelight_intel_view = view () {
    Corelight_view | where EventType == "intel"
    | extend
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        EventUid=column_ifexists('uid', ''),
        Fuid=column_ifexists('fuid', ''),
        FileMimeType=column_ifexists('file_mime_type', ''),
        FileDesc=column_ifexists('file_desc', ''),
        Matched=column_ifexists('matched', ''),
        SeenIndicator=column_ifexists('seen.indicator', ''),
        SeenIndicatorType=column_ifexists('seen.indicator_type', ''),
        Host=column_ifexists('host', ''),
        Node=column_ifexists('node', ''),
        SeenWhere=column_ifexists('seen.where', ''),
        Sources=column_ifexists('sources', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        EventUid,
        Fuid,
        FileMimeType,
        FileDesc,
        Matched,
        SeenIndicator,
        SeenIndicatorType,
        Host,
        Node,
        SeenWhere,
        Sources
};
let Corelight_notice_view = view () {
    Corelight_view | where EventType == "notice"
    | extend
        EventUid=column_ifexists('uid', ''),
        Fuid=column_ifexists('fuid', ''),
        FileDesc=column_ifexists('file_desc', ''),
        FileMimeType=column_ifexists('file_mime_type', ''),
        Src=column_ifexists('src', ''),
        NetworkProtocol=column_ifexists('proto', ''),
        Actions=column_ifexists('actions', ''),
        Dropped=column_ifexists('dropped', ''),
        EmailBodySections=column_ifexists('email_body_sections', ''),
        Msg=column_ifexists('msg', ''),
        Note=column_ifexists('note', ''),
        N=column_ifexists('n', ''),
        PeerDescr=column_ifexists('peer_descr', ''),
        Sub=column_ifexists('sub', ''),
        SubpressFor=column_ifexists('subpress_for', ''),
        Dst=column_ifexists('dst', ''),
        P=column_ifexists('p', ''),
        RemoteLocationCountryCode=column_ifexists('remote_location.country_code', ''),
        RemoteLocationRegion=column_ifexists('remote_location.region', ''),
        RemoteLocationCity=column_ifexists('remote_location.city', ''),
        RemoteLocationLatitude=column_ifexists('remote_location.latitude', ''),
        RemoteLocationLongitude=column_ifexists('remote_location.longitude', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        EventUid,
        Fuid,
        FileDesc,
        FileMimeType,
        Src,
        NetworkProtocol,
        Actions,
        Dropped,
        EmailBodySections,
        Msg,
        Note,
        N,
        PeerDescr,
        Sub,
        SubpressFor,
        Dst,
        P,
        RemoteLocationCountryCode,
        RemoteLocationRegion,
        RemoteLocationCity,
        RemoteLocationLatitude,
        RemoteLocationLongitude       
};

let Corelight_ntlm_view = view () {
    Corelight_view | where EventType == "ntlm"
    | extend
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        EventUid=column_ifexists('uid', ''),
        Domainname=column_ifexists('domainname', ''),
        Hostname=column_ifexists('hostname', ''),
        Username=column_ifexists('username', ''),
        ServerNbComputerName=column_ifexists('server_nb_computer_name', ''),
        ServerTreeName=column_ifexists('server_tree_name', ''),
        Success=column_ifexists('success', ''),
        ServerDnsComputerName=column_ifexists('server_dns_computer_name', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        EventUid,
        Domainname,
        Hostname,
        Username,
        ServerNbComputerName,
        ServerTreeName,
        Success,
        ServerDnsComputerName
};
let Corelight_pe_view = view () {
    Corelight_view | where EventType == "pe"
    | extend
        Fuid=column_ifexists('fuid', ''),
        CompileTs=column_ifexists('compile_ts', ''),
        HasCertTable=column_ifexists('has_cert_table', ''),
        HasDebugData=column_ifexists('has_debug_data', ''),
        HasImportTable=column_ifexists('has_import_table', ''),
        HasExportTable=column_ifexists('has_export_table', ''),
        Is64bit=column_ifexists('is_64bit', ''),
        IsExe=column_ifexists('is_exe', ''),
        Machine=column_ifexists('machine', ''),
        Os=column_ifexists('os', ''),
        SectionNames=column_ifexists('section_names', ''),
        Subsystem=column_ifexists('subsystem', ''),
        UsesAslr=column_ifexists('uses_aslr', ''),
        UsesCodeIntegrity=column_ifexists('uses_code_integrity', ''),
        UsesDep=column_ifexists('uses_dep', ''),
        UsesSeh=column_ifexists('uses_seh', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        Fuid,
        CompileTs,
        HasCertTable,
        HasDebugData,
        HasImportTable,
        HasExportTable,
        Is64bit,
        IsExe,
        Machine,
        Os,
        SectionNames,
        Subsystem,
        UsesAslr,
        UsesCodeIntegrity,
        UsesDep,
        UsesSeh     
};

let Corelight_smb_files_view = view () {
    Corelight_view | where EventType == "smb_files"
    | extend
        SmbAction=column_ifexists('action', ''),
        ZeekIdFuid=column_ifexists('fuid', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        ShareRelativeTargetName=column_ifexists('name', ''),
        ShareName=column_ifexists('path', ''),
        FilePreviousName=column_ifexists('prev_name', ''),
        FileSize=column_ifexists('size', ''),
        FileAccessedTime=column_ifexists('times_accessed', ''),
        FileChangedTime=column_ifexists('times_changed', ''),
        FileCreationTime=column_ifexists('times_created', ''),
        FileModifiedTime=column_ifexists('times_modified', ''),
        EventUid=column_ifexists('uid', ''),
        NetworkProtocol="tcp"
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        SmbAction,
        ZeekIdFuid,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        ShareRelativeTargetName,
        ShareName,
        FilePreviousName,
        FileSize,
        FileAccessedTime,
        FileChangedTime,
        FileCreationTime,
        FileModifiedTime,
        EventUid,
        NetworkProtocol
};

let Corelight_smb_mapping_view = view () {
    Corelight_view | where EventType == "smb_mapping"
    | extend
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        FileSystemType=column_ifexists('native_file_system', ''),
        ShareName=column_ifexists('path', ''),
        Service=column_ifexists('service', ''),
        ShareType=column_ifexists('share_type', ''),
        EventUid=column_ifexists('uid', ''),
        NetworkProtocol="tcp"
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        FileSystemType,
        ShareName,
        Service,
        ShareType,
        EventUid,
        NetworkProtocol  
};

let Corelight_smtp_view = view () {
    Corelight_view | where EventType == "smtp"
    | extend
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        EventUid=column_ifexists('uid', ''),
        Fuids=column_ifexists('fuids', ''),
        Cc=column_ifexists('cc', ''),
        Date=column_ifexists('date', ''),
        FirstReceived=column_ifexists('first_received', ''),
        From=column_ifexists('from', ''),
        Helo=column_ifexists('helo', ''),
        InReplyTo=column_ifexists('in_reply_to', ''),
        IsWebmail=column_ifexists('is_webmail', ''),
        LastReply=column_ifexists('last_reply', ''),
        Mailfrom=column_ifexists('mailfrom', ''),
        MsgId=column_ifexists('msg_id', ''),
        Path=column_ifexists('path', ''),
        Rcptto=column_ifexists('rcptto', ''),
        ReplyTo=column_ifexists('reply_to', ''),
        SecondReceived=column_ifexists('second_received', ''),
        Subject=column_ifexists('subject', ''),
        Tls=column_ifexists('tls', ''),
        To=column_ifexists('to', ''),
        TransDepth=column_ifexists('trans_depth', ''),
        XOriginatingIp=column_ifexists('x_originating_ip', ''),
        UserAgent=column_ifexists('user_agent', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        EventUid,
        Fuids,
        Cc,
        Date,
        FirstReceived,
        From,
        Helo,
        InReplyTo,
        IsWebmail,
        LastReply,
        Mailfrom,
        MsgId,
        Path,
        Rcptto,
        ReplyTo,
        SecondReceived,
        Subject,
        Tls,
        To,
        TransDepth,
        XOriginatingIp,
        UserAgent
};

let Corelight_software_view = view () {
    Corelight_view | where EventType == "software"
    | extend
        VersionAddl=column_ifexists('version.addl', ''),
        Host=column_ifexists('host', ''),
        HostP=column_ifexists('host_p', ''),
        VersionMajor=column_ifexists('version.major', ''),
        VersionMinor=column_ifexists('version.minor', ''),
        VersionMinor2=column_ifexists('version.minor2', ''),
        VersionMinor3=column_ifexists('version.minor3', ''),
        Name=column_ifexists('name', ''),
        UnparsedVersion=column_ifexists('unparsed_version', ''),
        SoftwareType=column_ifexists('software_type', ''),
        Url=column_ifexists('url', '')
    | project
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        VersionAddl,
        Host,
        HostP,
        VersionMajor,
        VersionMinor,
        VersionMinor2,
        VersionMinor3,
        Name,
        UnparsedVersion,
        SoftwareType,
        Url
};

let Corelight_ssh_view = view () {
    Corelight_view | where EventType == "ssh"
    | extend
        AuthAttempts=column_ifexists('auth_attempts', ''),
        AuthSuccess=column_ifexists('auth_success', ''),
        CipherAlg=column_ifexists('cipher_alg', ''),
        Client=column_ifexists('client', ''),
        CompressionAlg=column_ifexists('compression_alg', ''),
        Cshka=column_ifexists('cshka', ''),
        Direction=column_ifexists('direction', ''),
        Hassh=column_ifexists('hassh', ''),
        Hasshalgorithms=column_ifexists('hasshAlgorithms', ''),
        Hasshserver=column_ifexists('hasshServer', ''),
        Hasshserveralgorithms=column_ifexists('hasshServerAlgorithms', ''),
        Hasshversion=column_ifexists('hasshVersion', ''),
        HostKey=column_ifexists('host_key', ''),
        HostKeyAlg=column_ifexists('host_key_alg', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        KexAlg=column_ifexists('kex_alg', ''),
        MacAlg=column_ifexists('mac_alg', ''),
        Server=column_ifexists('server', ''),
        EventUid=column_ifexists('uid', ''),
        Version=column_ifexists('version', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        AuthAttempts,
        AuthSuccess,
        CipherAlg,
        Client,
        CompressionAlg,
        Cshka,
        Direction,
        Hassh,
        Hasshalgorithms,
        Hasshserver,
        Hasshserveralgorithms,
        Hasshversion,
        HostKey,
        HostKeyAlg,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        KexAlg,
        MacAlg,
        Server,
        EventUid,
        Version     
};

let Corelight_ssl_view = view () {
    Corelight_view | where EventType == "ssl" or EventType == "ssl_red"
    | extend
        ZeekIdCertChainFuids=column_ifexists('cert_chain_fuids', ''),
        TlsCipher=column_ifexists('cipher', ''),
        ZeekIdClientCertChainFuids=column_ifexists('client_cert_chain_fuids', ''),
        CertificateIssuer=column_ifexists('client_issuer', ''),
        CertificateSubject=column_ifexists('client_subject', ''),
        TlsCurve=column_ifexists('curve', ''),
        TlsEstablished=column_ifexists('established', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        DstCertificateIssuerName=column_ifexists('issuer', ''),
        HashJa3=column_ifexists('ja3', ''),
        HashJa3s=column_ifexists('ja3s', ''),
        TlsLastAlert=column_ifexists('last_alert', ''),
        TlsNextProtocol=column_ifexists('next_protocol', ''),
        TlsNotaryResponse=column_ifexists('notary', ''),
        OscpValidationStatus=column_ifexists('ocsp_status', ''),
        CertificateHashSha1=column_ifexists('orig_certificate_sha1', ''),
        DstCertificateSha1=column_ifexists('resp_certificate_sha1', ''),
        TlsResumed=column_ifexists('resumed', ''),
        TlsServerName=column_ifexists('server_name', ''),
        DstCertificateSubjectName=column_ifexists('subject', ''),
        EventUid=column_ifexists('uid', ''),
        ValidCtLogs=column_ifexists('valid_ct_logs', ''),
        ValidCtOperators=column_ifexists('valid_ct_operators', ''),
        ValidCtOperatorsList=column_ifexists('valid_ct_operators_list', ''),
        TlsCertificateValidationStatus=column_ifexists('validation_status', ''),
        TlsVersion=column_ifexists('version', ''),
        TlsVersionNumber=column_ifexists('version_num', ''),
        DstHostName=column_ifexists('tls_server_name', ''),
        NetworkProtocol="tcp"
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        ZeekIdCertChainFuids,
        TlsCipher,
        ZeekIdClientCertChainFuids,
        CertificateIssuer,
        CertificateSubject,
        TlsCurve,
        TlsEstablished,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        DstCertificateIssuerName,
        HashJa3,
        HashJa3s,
        TlsLastAlert,
        TlsNextProtocol,
        TlsNotaryResponse,
        OscpValidationStatus,
        CertificateHashSha1,
        DstCertificateSha1,
        TlsResumed,
        TlsServerName,
        DstCertificateSubjectName,
        EventUid,
        ValidCtLogs,
        ValidCtOperators,
        ValidCtOperatorsList,
        TlsCertificateValidationStatus,
        TlsVersion,
        TlsVersionNumber,
        DstHostName,
        NetworkProtocol
};
let Corelight_weird_view = view () {
    Corelight_view | where EventType == "weird" or EventType == "weird_red"
    | extend
        EventUid=column_ifexists('uid', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        Name=column_ifexists('name', ''),
        Notice=column_ifexists('notice', ''),
        Peer=column_ifexists('peer', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        EventUid,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        Name,
        Notice,
        Peer
};

let Corelight_x509_view = view () {
    Corelight_view | where EventType == "x509"
    | extend
        Id=column_ifexists('id', ''),
        BasicConstraintsCa=column_ifexists('basic_constraints.ca', ''),
        BasicConstraintsPathLen=column_ifexists('basic_constraints.path_len', ''),
        CertificateCn=column_ifexists('certificate.cn', ''),
        CertificateCurve=column_ifexists('certificate.curve', ''),
        CertificateExponent=column_ifexists('certificate.exponent', ''),
        CertificateIssuer=column_ifexists('certificate.issuer', ''),
        CertificateKeyAlg=column_ifexists('certificate.key_alg', ''),
        CertificateKeyLength=column_ifexists('certificate.key_length', ''),
        CertificateKeyType=column_ifexists('certificate.key_type', ''),
        CertificateNotValidAfter=column_ifexists('certificate.not_valid_after', ''),
        CertificateNotValidBefore=column_ifexists('certificate.not_valid_before', ''),
        CertificateSerial=column_ifexists('certificate.serial', ''),
        CertificateSigAlg=column_ifexists('certificate.sig_alg', ''),
        CertificateSubject=column_ifexists('certificate.subject', ''),
        CertificateVersion=column_ifexists('certificate.version', ''),
        Logcert=column_ifexists('logcert', ''),
        SanDns=column_ifexists('san.dns', ''),
        SanEmail=column_ifexists('san.email', ''),
        SanIp=column_ifexists('san.ip', ''),
        SanUri=column_ifexists('san.uri', '') 
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        Id,
        BasicConstraintsCa,
        BasicConstraintsPathLen,
        CertificateCn,
        CertificateCurve,
        CertificateExponent,
        CertificateIssuer,
        CertificateKeyAlg,
        CertificateKeyLength,
        CertificateKeyType,
        CertificateNotValidAfter,
        CertificateNotValidBefore,
        CertificateSerial,
        CertificateSigAlg,
        CertificateSubject,
        CertificateVersion,
        Logcert,
        SanDns,
        SanEmail,
        SanIp,
        SanUri
        
};

let Corelight_ftp_view = view () {
    Corelight_view | where EventType == "ftp"
    | extend
            EventUid=column_ifexists('uid', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        Fuid=column_ifexists('fuid', ''),
        UserName=column_ifexists('user', ''),
        UserPassword=column_ifexists('password', ''),
        FtpProcessName=column_ifexists('command', ''),
        FtpCommandLine=column_ifexists('arg', ''),
        MimeType=column_ifexists('mime_type', ''),
        FileSize=column_ifexists('file_size', ''),
        ReplyCode=column_ifexists('reply_code', ''),
        ReplyMsg=column_ifexists('reply_msg', ''),
        FileDirectory=column_ifexists('cwd', ''),
        DataChannelOrigH=column_ifexists('data_channel.orig_h', ''),
        DataChannelPassive=column_ifexists('data_channel.passive', ''),
        DataChannelRespH=column_ifexists('data_channel.resp_h', ''),
        DataChannelRespP=column_ifexists('data_channel.resp_p', ''),
        FtpPassive=column_ifexists('ftp_passive', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        EventUid,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        Fuid,
        UserName,
        UserPassword,
        FtpProcessName,
        FtpCommandLine,
        MimeType,
        FileSize,
        ReplyCode,
        ReplyMsg,
        FileDirectory,
        DataChannelOrigH,
        DataChannelPassive,
        DataChannelRespH,
        DataChannelRespP,
        FtpPassive
};

let Corelight_tunnel_view = view () {
    Corelight_view | where EventType == "tunnel"
    | extend
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        EventUid=column_ifexists('uid', ''),
        Action=column_ifexists('action', ''),
        TunnelType=column_ifexists('tunnel_type', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        EventUid,
        Action,
        TunnelType
};
let Corelight_dnp3_view = view () {
    Corelight_view | where EventType == "dnp3"
    | extend
        NetworkProtocol=column_ifexists('proto', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        EventUid=column_ifexists('uid', ''),
        Dnp3FunctionReply=column_ifexists('fc_reply', ''),
        Dnp3FunctionRequest=column_ifexists('fc_request', ''),
        Dnp3Iin=column_ifexists('iin', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        NetworkProtocol,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        EventUid,
        Dnp3FunctionReply,
        Dnp3FunctionRequest,
        Dnp3Iin
};
let Corelight_other_view = view () {
    Corelight_view | where EventType != "http" and 
                        EventType != "http_red" and 
                        EventType != "conn" and
                        EventType != "conn_red" and
                        EventType != "dns" and
                        EventType != "dns_red" and
                        EventType != "files" and
                        EventType != "files_red" and
                        EventType != "dpd" and
                        EventType != "dhcp" and
                        EventType != "intel" and
                        EventType != "notice" and
                        EventType != "ntlm" and
                        EventType != "pe" and
                        EventType != "smb_files" and
                        EventType != "smb_mapping" and
                        EventType != "smtp" and
                        EventType != "software" and
                        EventType != "ssh" and
                        EventType != "ssl" and
                        EventType != "ssl_red" and
                        EventType != "weird" and
                        EventType != "weird_red" and
                        EventType != "x509" and
                        EventType != "ftp" and
                        EventType != "tunnel" and
                        EventType != "dnp3"
    | extend
        NetworkProtocol=column_ifexists('proto', ''),
        SrcIpAddr=column_ifexists('id.orig_h', ''),
        SrcPort=column_ifexists('id.orig_p', ''),
        DstIpAddr=column_ifexists('id.resp_h', ''),
        DstPort=column_ifexists('id.resp_p', ''),
        EventUid=column_ifexists('uid', '')
    | project
        Message,
        TimeGenerated, 
        EventType,
        EventVendor,
        EventProduct,
        SrcDvcHostname,
        EventEndTime,
        SrcDvcFile,
        NetworkProtocol,
        SrcIpAddr,
        SrcPort,
        DstIpAddr,
        DstPort,
        EventUid
};
union isfuzzy=true  Corelight_http_view,
                    Corelight_conn_view,
                    Corelight_dns_view,
                    Corelight_files_view, 
                    Corelight_dpd_view, 
                    Corelight_dhcp_view, 
                    Corelight_intel_view,
                    Corelight_notice_view,
                    Corelight_ntlm_view,
                    Corelight_pe_view, 
                    Corelight_smb_files_view, 
                    Corelight_smb_mapping_view, 
                    Corelight_smtp_view, 
                    Corelight_software_view,
                    Corelight_ssh_view, 
                    Corelight_ssl_view, 
                    Corelight_weird_view, 
                    Corelight_x509_view, 
                    Corelight_ftp_view, 
                    Corelight_tunnel_view, 
                    Corelight_dnp3_view,
                    Corelight_other_view